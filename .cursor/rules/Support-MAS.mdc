---
alwaysApply: true
---
# Project Rules: –ù–µ–π—Ä–æ-—Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –®–∫–æ–ª—ã –ú–∏—Ö–∞–∏–ª–∞ –ê–≥–µ–µ–≤–∞

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 13.02.2026  
**–ü—Ä–∏–º–µ–Ω–∏–º–æ –¥–ª—è:** Cursor AI, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

---

## 1. –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 1.1. –§–∏–ª–æ—Å–æ—Ñ–∏—è –∫–æ–¥–∞
- **Clean Code:** –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º—ã–º
- **DRY (Don't Repeat Yourself):** –ò–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- **KISS (Keep It Simple, Stupid):** –ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- **YAGNI (You Aren't Gonna Need It):** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ "–Ω–∞ –±—É–¥—É—â–µ–µ"
- **Single Responsibility:** –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É

### 1.2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (API –∫–ª—é—á–∏, –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã)
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI)
4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** (–ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏)
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É –Ω–∞–≥—Ä—É–∑–∫–∏)

---

## 2. Python Code Style

### 2.1. –°—Ç–∞–Ω–¥–∞—Ä—Ç –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- **PEP 8:** –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É Python
- **Type Hints:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –≤–µ–∑–¥–µ
- **Line Length:** –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤
- **Encoding:** UTF-8 –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

### 2.2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
async def generate_response(
    question: str,
    context: str,
    history: List[Dict[str, str]],
    temperature: float = 0.7
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ GPT-4.1-mini.
    
    Args:
        question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ RAG
        history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
        temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        
    Returns:
        str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
        
    Raises:
        OpenAIError: –û—à–∏–±–∫–∞ API OpenAI
    """
    try:
        response = await self.client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=self._build_messages(question, context, history),
            temperature=temperature,
            max_tokens=800
        )
        return response.choices[0].message.content
    except Exception as e:
        logger.error(f"AI generation error: {e}")
        raise

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
def generate(q,c,h,t=0.7):  # –ù–µ—Ç —Ç–∏–ø–æ–≤, –Ω–µ—è—Å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    r=self.client.chat.completions.create(model="gpt-4.1-mini",messages=build(q,c,h),temperature=t,max_tokens=800)  # –î–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    return r.choices[0].message.content  # –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
```

### 2.3. Naming Conventions

```python
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: UPPER_CASE
MAX_CONTEXT_MESSAGES = 5
RATE_LIMIT_WINDOW = 3600
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# –ö–ª–∞—Å—Å—ã: PascalCase
class RAGEngine:
    pass

class ContextManager:
    pass

# –§—É–Ω–∫—Ü–∏–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: snake_case
async def search_knowledge_base(query: str) -> List[Dict]:
    pass

user_question = "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?"
rag_results = await search_knowledge_base(user_question)

# –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã: _leading_underscore
class AIClient:
    def _build_messages(self, question: str) -> List[Dict]:
        pass
    
    async def generate_response(self, question: str) -> str:
        messages = self._build_messages(question)
        # ...

# –ë—É–ª–µ–≤—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: is_, has_, should_
is_spam = await spam_filter.check(message)
has_context = len(history) > 0
should_redirect = similarity_score < 0.5
```

### 2.4. Imports

```python
# –ü–æ—Ä—è–¥–æ–∫ –∏–º–ø–æ—Ä—Ç–æ–≤:
# 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
# 2. –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
# 3. –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
import os
import json
from typing import List, Dict, Optional
from datetime import datetime

from fastapi import FastAPI, HTTPException
from openai import AsyncOpenAI
from loguru import logger

from app.core.rag_engine import RAGEngine
from app.database.models import UniqueQuestion
from app.utils.validators import validate_message

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
from app.core.rag_engine import RAGEngine  # –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
import os  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ—Å–ª–µ
from fastapi import FastAPI
```

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### 3.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
# app/core/rag_engine.py
class RAGEngine:
    """–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞ —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º"""
    async def search(self, query: str) -> List[Dict]:
        pass

# app/core/ai_client.py  
class AIClient:
    """–¢–æ–ª—å–∫–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å OpenAI API"""
    async def generate_response(self, prompt: str) -> str:
        pass

# app/integrations/telegram_bot.py
class TelegramHandler:
    """–¢–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π"""
    def __init__(self, rag: RAGEngine, ai: AIClient):
        self.rag = rag
        self.ai = ai

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –í—Å–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
class MegaHandler:
    """–î–µ–ª–∞–µ—Ç –≤—Å–µ: RAG, AI, Telegram, Jivo, DB"""
    pass
```

### 3.2. Dependency Injection

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
class MessageHandler:
    def __init__(
        self,
        rag_engine: RAGEngine,
        ai_client: AIClient,
        context_manager: ContextManager,
        rate_limiter: RateLimiter
    ):
        self.rag = rag_engine
        self.ai = ai_client
        self.context = context_manager
        self.limiter = rate_limiter

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
rag = RAGEngine(knowledge_path, index_path)
ai = AIClient(api_key)
context = ContextManager(max_messages=5)
limiter = RateLimiter(max_requests=20)

handler = MessageHandler(rag, ai, context, limiter)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ñ–µ—Å—Ç–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
class MessageHandler:
    def __init__(self):
        self.rag = RAGEngine("hardcoded/path")  # –ñ–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω—ã–π –ø—É—Ç—å
        self.ai = AIClient("sk-hardcoded-key")   # –ö–ª—é—á –≤ –∫–æ–¥–µ!
```

### 3.3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Pydantic Settings
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    openai_api_key: str
    telegram_bot_token: str
    max_context_messages: int = 5
    rate_limit_requests: int = 20
    
    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ü—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ .env
OPENAI_KEY = "sk-hardcoded"  # –ö–ª—é—á –≤ –∫–æ–¥–µ
MAX_MESSAGES = 5  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Ñ–∏–≥–∞
```

---

## 4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

### 4.1. Async/Await

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async def handle_message(user_id: str, text: str) -> str:
    """–í—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ"""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit (–±—ã—Å—Ç—Ä–æ, –º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    if not await rate_limiter.check(user_id):
        raise RateLimitError()
    
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    context_task = context_manager.get_context(user_id)
    rag_task = rag_engine.search(text)
    
    context, rag_results = await asyncio.gather(
        context_task,
        rag_task
    )
    
    # AI –∑–∞–ø—Ä–æ—Å (I/O bound)
    response = await ai_client.generate(text, context, rag_results)
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (I/O bound)
    await questions_db.add_question(text)
    
    return response

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
def handle_message(user_id: str, text: str) -> str:
    context = context_manager.get_context(user_id)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ!
    rag_results = rag_engine.search(text)           # –ë–ª–æ–∫–∏—Ä—É–µ—Ç!
    response = ai_client.generate(text)              # –ñ–¥–µ–º –æ—Ç–≤–µ—Ç!
    return response
```

### 4.2. Error Handling –≤ async

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
async def safe_ai_call(prompt: str) -> Optional[str]:
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ AI —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        response = await ai_client.generate(prompt)
        return response
    except OpenAIError as e:
        logger.error(f"OpenAI API error: {e}")
        return None
    except asyncio.TimeoutError:
        logger.error("AI request timeout")
        return None
    except Exception as e:
        logger.exception(f"Unexpected error: {e}")
        return None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
response = await safe_ai_call(prompt)
if response is None:
    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
async def ai_call(prompt: str) -> str:
    response = await ai_client.generate(prompt)  # –ö—Ä–∞—à –ø—Ä–∏ –æ—à–∏–±–∫–µ!
    return response
```

---

## 5. –†–∞–±–æ—Ç–∞ —Å AI –∏ RAG

### 5.1. RAG Best Practices

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings
class RAGEngine:
    def __init__(self):
        self.embedding_cache = {}  # LRU cache
    
    async def get_embedding(self, text: str) -> List[float]:
        """–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö embeddings"""
        cache_key = hashlib.md5(text.encode()).hexdigest()
        
        if cache_key in self.embedding_cache:
            return self.embedding_cache[cache_key]
        
        embedding = await self.openai.embeddings.create(
            model="text-embedding-3-small",
            input=text
        )
        
        self.embedding_cache[cache_key] = embedding.data[0].embedding
        return embedding.data[0].embedding

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ö–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
async def get_embedding(self, text: str) -> List[float]:
    embedding = await self.openai.embeddings.create(
        model="text-embedding-3-small",
        input=text
    )
    return embedding.data[0].embedding
```

### 5.2. Prompt Engineering

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç
SYSTEM_PROMPT_TEMPLATE = """
–¢—ã ‚Äî –Ω–µ–π—Ä–æ-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –®–∫–æ–ª—ã –ú–∏—Ö–∞–∏–ª–∞ –ê–≥–µ–µ–≤–∞.
–û—Ç–≤–µ—á–∞–π –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
2. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π "–±–∞–∑—É –∑–Ω–∞–Ω–∏–π" –≤ –æ—Ç–≤–µ—Ç–∞—Ö
3. –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ ‚Üí –Ω–∞–ø—Ä–∞–≤—å –≤ —Ö–µ–ª–ø-—á–∞—Ç: {help_chat_url}
4. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ ‚Üí —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º
5. –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –≤–æ–ø—Ä–æ—Å–∞

–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:
{rag_context}

–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
{conversation_history}

–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{user_question}
"""

def build_prompt(
    rag_context: str,
    history: List[Dict],
    question: str
) -> str:
    """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    if not rag_context:
        logger.warning("Empty RAG context")
    
    history_str = "\n".join([
        f"{msg['role']}: {msg['content']}" 
        for msg in history
    ])
    
    return SYSTEM_PROMPT_TEMPLATE.format(
        help_chat_url="https://t.me/Ageev_Help_chat",
        rag_context=rag_context,
        conversation_history=history_str,
        user_question=question
    )

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
def build_prompt(context, history, question):
    return "–¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. " + context + str(history) + question
```

### 5.3. Rate Limiting –¥–ª—è API

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Retry —Å exponential backoff
from tenacity import retry, stop_after_attempt, wait_exponential

class AIClient:
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=2, max=10)
    )
    async def generate_with_retry(self, prompt: str) -> str:
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö"""
        try:
            response = await self.client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=[{"role": "user", "content": prompt}],
                timeout=30.0
            )
            return response.choices[0].message.content
        except RateLimitError:
            logger.warning("Rate limit hit, retrying...")
            raise  # Tenacity –ø–æ–≤—Ç–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å
        except Exception as e:
            logger.error(f"AI error: {e}")
            raise

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ë–µ–∑ retry
async def generate(self, prompt: str) -> str:
    response = await self.client.chat.completions.create(...)
    return response.choices[0].message.content  # –£–ø–∞–¥–µ—Ç –ø—Ä–∏ rate limit
```

---

## 6. Database –∏ Storage

### 6.1. SQLAlchemy Models

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ü–æ–ª–Ω–∞—è –º–æ–¥–µ–ª—å —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
from sqlalchemy import Column, Integer, String, DateTime, LargeBinary
from sqlalchemy.ext.declarative import declarative_base
from datetime import datetime

Base = declarative_base()

class UniqueQuestion(Base):
    __tablename__ = "unique_questions"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    question = Column(String(2000), nullable=False, index=True)
    embedding = Column(LargeBinary, nullable=False)  # Pickle embedding
    source = Column(String(20), nullable=False)  # "telegram" or "jivo"
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    count = Column(Integer, nullable=False, default=1)
    
    def __repr__(self):
        return f"<Question(id={self.id}, source={self.source}, count={self.count})>"

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ù–µ–ø–æ–ª–Ω–∞—è –º–æ–¥–µ–ª—å
class Question(Base):
    __tablename__ = "questions"
    id = Column(Integer, primary_key=True)
    text = Column(String)  # –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã, nullable
```

### 6.2. Database Operations

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine

async def add_unique_question(
    session: AsyncSession,
    question: str,
    embedding: bytes,
    source: str
) -> Optional[UniqueQuestion]:
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        similar = await find_similar_questions(session, embedding)
        if similar:
            similar.count += 1
            await session.commit()
            return similar
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
        new_question = UniqueQuestion(
            question=question,
            embedding=embedding,
            source=source
        )
        session.add(new_question)
        await session.commit()
        await session.refresh(new_question)
        
        return new_question
        
    except Exception as e:
        await session.rollback()
        logger.error(f"DB error: {e}")
        raise

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
def add_question(question, embedding, source):
    q = UniqueQuestion(question=question, embedding=embedding, source=source)
    session.add(q)
    session.commit()  # –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
    return q
```

---

## 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 7.1. Structured Logging

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
from loguru import logger
import json

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger.add(
    "logs/app_{time:YYYY-MM-DD}.log",
    rotation="00:00",
    retention="30 days",
    compression="zip",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level} | {message}",
    serialize=True  # JSON —Ñ–æ—Ä–º–∞—Ç
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
@logger.catch  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π catch –∏—Å–∫–ª—é—á–µ–Ω–∏–π
async def handle_message(user_id: str, text: str) -> str:
    logger.info(
        "Processing message",
        extra={
            "user_id": user_id,
            "message_length": len(text),
            "source": "telegram"
        }
    )
    
    try:
        response = await generate_response(text)
        
        logger.info(
            "Message processed successfully",
            extra={
                "user_id": user_id,
                "response_length": len(response),
                "processing_time_ms": 1250
            }
        )
        
        return response
        
    except Exception as e:
        logger.error(
            "Message processing failed",
            extra={
                "user_id": user_id,
                "error": str(e),
                "error_type": type(e).__name__
            }
        )
        raise

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ü—Ä–æ—Å—Ç—ã–µ print –∏–ª–∏ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
def handle_message(user_id, text):
    print(f"Got message from {user_id}")  # –ü–ª–æ—Ö–æ!
    logger.info("Processing...")  # –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    response = generate_response(text)
    print("Done")  # –ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π
    return response
```

### 7.2. –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# DEBUG - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logger.debug(f"RAG search returned {len(results)} chunks")

# INFO - –û–±—ã—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
logger.info(f"User {user_id} sent message")

# WARNING - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
logger.warning(f"Low similarity score: {score}")

# ERROR - –û—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–∞–¥–∞—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
logger.error(f"Failed to save to DB: {e}")

# CRITICAL - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
logger.critical(f"OpenAI API key is invalid!")
```

---

## 8. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 8.1. Secrets Management

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Secrets –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    openai_api_key: str  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
    telegram_bot_token: str
    admin_password_hash: str
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

settings = Settings()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
client = AsyncOpenAI(api_key=settings.openai_api_key)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –•–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤
OPENAI_KEY = "sk-proj-abc123..."  # –ù–ò–ö–û–ì–î–ê!
TELEGRAM_TOKEN = "1234567:ABC..."  # –ù–ò–ö–û–ì–î–ê!
```

### 8.2. Input Validation

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
from pydantic import BaseModel, validator, Field

class UserMessage(BaseModel):
    user_id: str = Field(..., min_length=1, max_length=100)
    text: str = Field(..., min_length=1, max_length=2000)
    source: str = Field(..., regex="^(telegram|jivo)$")
    
    @validator("text")
    def validate_text(cls, v):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º-–ø–∞—Ç—Ç–µ—Ä–Ω—ã"""
        if len(v.strip()) < 3:
            raise ValueError("Message too short")
        if v.count("http") > 3:
            raise ValueError("Too many links")
        return v.strip()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
@app.post("/api/message")
async def receive_message(message: UserMessage):
    """FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç"""
    response = await handler.process(message.user_id, message.text)
    return {"response": response}

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
@app.post("/api/message")
async def receive_message(data: dict):
    user_id = data["user_id"]  # –ú–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å!
    text = data["text"]  # –ú–æ–∂–µ—Ç –±—ã—Ç—å None!
    response = await handler.process(user_id, text)  # –ö—Ä–∞—à!
```

### 8.3. SQL Injection Prevention

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (SQLAlchemy ORM)
from sqlalchemy import select

async def get_questions_by_source(session: AsyncSession, source: str):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ ORM"""
    stmt = select(UniqueQuestion).where(
        UniqueQuestion.source == source
    )
    result = await session.execute(stmt)
    return result.scalars().all()

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ (SQL Injection!)
async def get_questions(session, source):
    query = f"SELECT * FROM questions WHERE source = '{source}'"
    result = await session.execute(query)  # –û–ü–ê–°–ù–û!
```

---

## 9. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 9.1. Unit Tests

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ unit —Ç–µ—Å—Ç—ã
import pytest
from unittest.mock import AsyncMock, MagicMock

@pytest.fixture
def rag_engine():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è RAG Engine"""
    engine = RAGEngine(
        knowledge_path="tests/fixtures/test_knowledge.md",
        index_path="tests/fixtures/test_index"
    )
    return engine

@pytest.mark.asyncio
async def test_search_returns_relevant_results(rag_engine):
    """–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
    query = "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É?"
    
    results = await rag_engine.search(query, top_k=3)
    
    assert len(results) == 3
    assert all(r["score"] > 0.5 for r in results)
    assert "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è" in results[0]["text"].lower()

@pytest.mark.asyncio
async def test_ai_client_with_mock():
    """–¢–µ—Å—Ç AI –∫–ª–∏–µ–Ω—Ç–∞ —Å –º–æ–∫–æ–º OpenAI"""
    mock_openai = AsyncMock()
    mock_openai.chat.completions.create.return_value = MagicMock(
        choices=[MagicMock(message=MagicMock(content="–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç"))]
    )
    
    ai_client = AIClient(client=mock_openai)
    response = await ai_client.generate("–¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å")
    
    assert response == "–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç"
    mock_openai.chat.completions.create.assert_called_once()

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API
async def test_ai_client():
    client = AIClient(api_key="sk-real-key")  # –¢—Ä–∞—Ç–∏—Ç –¥–µ–Ω—å–≥–∏!
    response = await client.generate("–¢–µ—Å—Ç")  # –ú–µ–¥–ª–µ–Ω–Ω–æ!
    assert response  # –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ!
```

### 9.2. Integration Tests

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
@pytest.fixture
async def test_db():
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    async with AsyncSession(engine) as session:
        yield session
    
    await engine.dispose()

@pytest.mark.asyncio
async def test_add_unique_question_flow(test_db):
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞"""
    question = "–¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å"
    embedding = b"fake_embedding"
    source = "telegram"
    
    # –ü–µ—Ä–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    q1 = await add_unique_question(test_db, question, embedding, source)
    assert q1.count == 1
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ (–¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏—Ç—å count)
    q2 = await add_unique_question(test_db, question, embedding, source)
    assert q2.id == q1.id
    assert q2.count == 2
```

### 9.3. Test Coverage

```bash
# –¶–µ–ª—å: –º–∏–Ω–∏–º—É–º 80% –ø–æ–∫—Ä—ã—Ç–∏—è
pytest tests/ --cov=app --cov-report=html --cov-report=term

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫—Ä—ã–≤–∞—Ç—å:
# - –ö—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (RAG, AI)
# - –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
# - –í–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
# - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (rate limiting, spam filter)
```

---

## 10. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 10.1. Docstrings

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Google Style Docstrings
def calculate_similarity(embedding1: List[float], embedding2: List[float]) -> float:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç cosine similarity –º–µ–∂–¥—É –¥–≤—É–º—è embeddings.
    
    Args:
        embedding1: –ü–µ—Ä–≤—ã–π –≤–µ–∫—Ç–æ—Ä embedding
        embedding2: –í—Ç–æ—Ä–æ–π –≤–µ–∫—Ç–æ—Ä embedding
        
    Returns:
        float: –ó–Ω–∞—á–µ–Ω–∏–µ similarity –æ—Ç 0 –¥–æ 1
        
    Raises:
        ValueError: –ï—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä—ã —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã
        
    Example:
        >>> emb1 = [0.1, 0.2, 0.3]
        >>> emb2 = [0.2, 0.3, 0.4]
        >>> similarity = calculate_similarity(emb1, emb2)
        >>> print(f"{similarity:.2f}")
        0.99
    """
    if len(embedding1) != len(embedding2):
        raise ValueError("Embeddings must have same length")
    
    return np.dot(embedding1, embedding2) / (
        np.linalg.norm(embedding1) * np.linalg.norm(embedding2)
    )

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
def calc_sim(e1, e2):
    return np.dot(e1, e2) / (np.linalg.norm(e1) * np.linalg.norm(e2))
```

### 10.2. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –û–±—ä—è—Å–Ω–µ–Ω–∏–µ "–ø–æ—á–µ–º—É", –∞ –Ω–µ "—á—Ç–æ"
async def process_message(text: str) -> str:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —à–∫–æ–ª—ã,
    # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å false positives –Ω–∞ –¥—É—Ö–æ–≤–Ω—ã–µ —Ç–µ–º—ã
    similarity_threshold = 0.85
    
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 3 —á–∞–Ω–∫–∞, —Ç.–∫. –±–æ–ª—å—à–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ "—Ä–∞–∑–º—ã–≤–∞–Ω–∏—é"
    # –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–æ–º—Ç–µ –∏ –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º
    rag_results = await rag.search(text, top_k=3)
    
    return await ai.generate(text, rag_results)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –û—á–µ–≤–∏–¥–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
async def process_message(text: str) -> str:
    threshold = 0.85  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥ –≤ 0.85
    results = await rag.search(text, top_k=3)  # –ò—â–µ–º 3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    return await ai.generate(text, results)  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
```

---

## 11. Git Workflow

### 11.1. Commit Messages

```bash
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Conventional Commits
git commit -m "feat: add FAISS indexing for knowledge base"
git commit -m "fix: handle rate limit errors in Telegram handler"
git commit -m "docs: update README with deployment instructions"
git commit -m "refactor: extract prompt building into separate function"
git commit -m "test: add unit tests for RAG engine"

# –¢–∏–ø—ã –∫–æ–º–º–∏—Ç–æ–≤:
# feat: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
# fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞
# docs: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
# refactor: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞
# test: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
# chore: —Ä—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
git commit -m "fixes"
git commit -m "update"
git commit -m "asdf"
```

### 11.2. Branching Strategy

```bash
# main - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (production)
# develop - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
# feature/* - –Ω–æ–≤—ã–µ —Ñ–∏—á–∏
# bugfix/* - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
# hotfix/* - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

# –ü—Ä–∏–º–µ—Ä workflow:
git checkout develop
git checkout -b feature/jivo-integration
# ... —Ä–∞–±–æ—Ç–∞ ...
git add .
git commit -m "feat: add Jivo webhook handler"
git push origin feature/jivo-integration
# –°–æ–∑–¥–∞—Ç—å Pull Request: feature/jivo-integration ‚Üí develop
```

---

## 12. Performance Optimization

### 12.1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - LRU Cache –¥–ª—è embeddings
from functools import lru_cache
import hashlib

class RAGEngine:
    @lru_cache(maxsize=1000)
    def _get_text_hash(self, text: str) -> str:
        """–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö—ç—à–µ–π —Ç–µ–∫—Å—Ç–∞"""
        return hashlib.md5(text.encode()).hexdigest()
    
    async def search(self, query: str, top_k: int = 3) -> List[Dict]:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º embedding
        cache_key = self._get_text_hash(query)
        
        if cache_key in self.embedding_cache:
            embedding = self.embedding_cache[cache_key]
        else:
            embedding = await self._create_embedding(query)
            self.embedding_cache[cache_key] = embedding
        
        # –ü–æ–∏—Å–∫ –≤ FAISS
        distances, indices = self.index.search(
            np.array([embedding], dtype=np.float32),
            top_k
        )
        
        return self._format_results(indices, distances)
```

### 12.2. Batch Operations

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
async def process_multiple_questions(
    questions: List[str]
) -> List[Dict]:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
    
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings
    embedding_tasks = [
        create_embedding(q) for q in questions
    ]
    embeddings = await asyncio.gather(*embedding_tasks)
    
    # –ë–∞—Ç—á–µ–≤—ã–π –ø–æ–∏—Å–∫ –≤ FAISS (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø–æ –æ–¥–Ω–æ–º—É)
    distances, indices = index.search(
        np.array(embeddings, dtype=np.float32),
        k=3
    )
    
    return format_batch_results(indices, distances)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
async def process_multiple_questions(questions: List[str]) -> List[Dict]:
    results = []
    for q in questions:  # –ú–µ–¥–ª–µ–Ω–Ω–æ!
        embedding = await create_embedding(q)
        result = index.search(embedding, k=3)
        results.append(result)
    return results
```

---

## 13. Error Messages

### 13.1. User-Facing Messages

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
ERROR_MESSAGES = {
    "rate_limit": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {minutes} –º–∏–Ω—É—Ç. üòä",
    "spam_detected": "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.",
    "no_answer": "–¢–æ—á–Ω—ã–π –∏ —Å–∞–º—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –≤–∞–º –¥–∞–¥—É—Ç –∫—É—Ä–∞—Ç–æ—Ä—ã –≤ —Ö–µ–ª–ø-—á–∞—Ç–µ https://t.me/Ageev_Help_chat",
    "off_topic": "–ù–∞ —Ç–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∑–¥–µ—Å—å –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ç–µ–º–∞—Ç–∏–∫–µ –®–∫–æ–ª—ã –∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è. üôè",
    "server_error": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
}

async def handle_error(error: Exception, user_id: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    if isinstance(error, RateLimitError):
        minutes = error.retry_after // 60
        return ERROR_MESSAGES["rate_limit"].format(minutes=minutes)
    
    elif isinstance(error, SpamError):
        logger.warning(f"Spam detected from user {user_id}")
        return ERROR_MESSAGES["spam_detected"]
    
    else:
        logger.error(f"Unexpected error for user {user_id}: {error}")
        return ERROR_MESSAGES["server_error"]

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
async def handle_error(error: Exception) -> str:
    return f"Error: {str(error)}"  # "RateLimitError: too many requests"
```

---

## 14. Monitoring –∏ Health Checks

### 14.1. Health Check Endpoint

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
from enum import Enum

class HealthStatus(str, Enum):
    HEALTHY = "healthy"
    DEGRADED = "degraded"
    UNHEALTHY = "unhealthy"

@app.get("/health")
async def health_check() -> Dict:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
    checks = {}
    overall_status = HealthStatus.HEALTHY
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ OpenAI API
    try:
        await ai_client.test_connection()
        checks["openai_api"] = "ok"
    except Exception as e:
        checks["openai_api"] = f"error: {str(e)}"
        overall_status = HealthStatus.UNHEALTHY
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ FAISS –∏–Ω–¥–µ–∫—Å–∞
    try:
        if rag_engine.index is not None:
            checks["faiss_index"] = "ok"
        else:
            checks["faiss_index"] = "not loaded"
            overall_status = HealthStatus.DEGRADED
    except Exception as e:
        checks["faiss_index"] = f"error: {str(e)}"
        overall_status = HealthStatus.UNHEALTHY
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
    try:
        await database.execute("SELECT 1")
        checks["database"] = "ok"
    except Exception as e:
        checks["database"] = f"error: {str(e)}"
        overall_status = HealthStatus.UNHEALTHY
    
    return {
        "status": overall_status,
        "checks": checks,
        "uptime_seconds": get_uptime(),
        "version": "1.0.0",
        "timestamp": datetime.utcnow().isoformat()
    }
```

---

## 15. Code Review Checklist

### –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—å:

- [ ] –ö–æ–¥ —Å–ª–µ–¥—É–µ—Ç PEP 8
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç type hints
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã docstrings –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤
- [ ] –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (try/except)
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è async/await –¥–ª—è I/O –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- [ ] –ù–µ—Ç SQL injection –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- [ ] –ù–∞–ø–∏—Å–∞–Ω—ã unit —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è API)
- [ ] Commit message —Å–ª–µ–¥—É–µ—Ç Conventional Commits
- [ ] –ö–æ–¥ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è (DRY)
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è

---

## 16. –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
black app/ --line-length 100
isort app/

# –õ–∏–Ω—Ç–∏–Ω–≥
flake8 app/ --max-line-length=100
mypy app/ --strict

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
pytest tests/ -v --cov=app --cov-report=html

# –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ
uvicorn app.main:app --reload --port 8000

# Docker
docker-compose up --build
docker-compose logs -f app

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip list --outdated
pip install -U package_name
pip freeze > requirements.txt
```

---

## 17. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–¥—É:**
- –°–æ–∑–¥–∞—Ç—å Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç –∫–æ–º–∞–Ω–¥—ã

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª:**
- –ü—Ä–∞–≤–∏–ª–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Pull Requests

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- v1.0.0 - –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è (13.02.2026)

---

_–≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –∂–∏–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª ‚Äî –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª._
